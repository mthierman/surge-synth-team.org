---
import { getCollection, type CollectionEntry } from "astro:content";

const surge_xt_releases = (await getCollection(
    "surge_xt_releases",
)) as CollectionEntry<"surge_xt_releases">[];

const stable = surge_xt_releases.find(
    (r) => r.id === "stable",
) as CollectionEntry<"surge_xt_releases">;
---

<download-button
    data-windows={stable.data.windows}
    data-mac={stable.data.mac}
    data-linux={stable.data.linux}
    class="">
    <a
        id="surge-release-link"
        class="hover:shadow-surge-orange hover:text-surge-orange w-fit rounded-md bg-transparent p-2 font-semibold no-underline shadow dark:shadow-white/25"
        >Download</a
    >
</download-button>

<script>
    class DownloadButton extends HTMLElement {
        connectedCallback() {
            const releases = {
                windows: this.dataset.windows!,
                mac: this.dataset.mac!,
                linux: this.dataset.linux!,
            };

            const anchor = this.querySelector("a") as HTMLAnchorElement;

            let userAgent = window.navigator.userAgent;
            let platform = window.navigator.platform;
            let platforms = {
                mac: ["Macintosh", "MacIntel", "MacPPC", "Mac68K"],
                windows: ["Win32", "Win64", "Windows", "WinCE"],
                ios: ["iPhone", "iPad", "iPod"],
                bsd: ["FreeBSD", "FreeBSD amd64"],
            };

            let os = null;

            if (anchor) {
                if (platforms.mac.indexOf(platform) !== -1) {
                    anchor.innerText = "Download | macOS";
                    anchor.href = releases.mac;
                    os = "mac";
                } else if (platforms.windows.indexOf(platform) !== -1) {
                    anchor.innerText = "Download | Windows";
                    anchor.href = releases.windows;
                    os = "windows";
                } else if (platforms.bsd.indexOf(platform) !== -1) {
                    anchor.innerText = "Download for FreeBSD";
                    anchor.href =
                        "https://github.com/surge-synthesizer/surge/blob/main/doc/Linux-and-other-Unix-like-distributions.md#surge-on-freebsd";
                    os = "bsd";
                } else if (platforms.ios.indexOf(platform) !== -1) {
                    anchor.innerText = "Download";
                    anchor.href = "/downloads";
                    os = "ios";
                } else if (/Android/.test(userAgent)) {
                    anchor.innerText = "Download";
                    anchor.href = "/downloads";
                    os = "android";
                } else if (!os && /Linux/.test(platform)) {
                    anchor.innerText = "Download | Linux";
                    anchor.href = "https://github.com/surge-synthesizer/releases-xt/releases";
                    os = "linux";
                } else {
                    anchor.innerText = "Download";
                    anchor.href = "/downloads";
                }
            }
        }
    }

    customElements.define("download-button", DownloadButton);
</script>
