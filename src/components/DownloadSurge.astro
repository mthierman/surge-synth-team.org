---
import { getCollection, type CollectionEntry } from "astro:content";

const surge_xt_releases = (await getCollection(
    "surge_xt_releases",
)) as CollectionEntry<"surge_xt_releases">[];

const stable = surge_xt_releases.find(
    (r) => r.id === "stable",
) as CollectionEntry<"surge_xt_releases">;
---

<download-button
    data-windows={stable.data.windows}
    data-mac={stable.data.mac}
    data-linux={stable.data.linux}
    class="">
    <a
        id="surge-release-link"
        class="hover:shadow-surge-orange hover:text-surge-orange w-fit rounded-md bg-zinc-50 p-2 font-semibold text-zinc-950 no-underline shadow dark:shadow-white/25"
        >Download</a
    >
</download-button>

<script>
    import detect_platform from "../modules/detect_platform.ts";

    class DownloadButton extends HTMLElement {
        connectedCallback() {
            const releases = {
                windows: this.dataset.windows!,
                mac: this.dataset.mac!,
                linux: this.dataset.linux!,
            };

            const anchor = this.querySelector("a") as HTMLAnchorElement;

            let downloads_url = "https://surge-synthesizer.github.io/downloads/";
            let platform = detect_platform();

            if (anchor) {
                switch (platform) {
                    case "windows":
                        anchor.innerText = "Download | Windows";
                        anchor.href = releases.windows;
                        break;

                    case "mac":
                        anchor.innerText = "Download | macOS";
                        anchor.href = releases.mac;
                        break;

                    case "linux":
                        anchor.innerText = "Download | Linux";
                        anchor.href = releases.linux;
                        break;

                    case "bsd":
                        anchor.innerText = "Download | FreeBSD";
                        anchor.href =
                            "https://github.com/surge-synthesizer/surge/blob/main/doc/Linux-and-other-Unix-like-distributions.md#surge-on-freebsd";
                        break;

                    case "android":
                    case "ios":
                    case "unknown":
                        anchor.innerText = "Download";
                        anchor.href = downloads_url;
                        break;

                    default:
                        anchor.innerText = "Download";
                        anchor.href = downloads_url;
                        break;
                }
            }
        }
    }

    customElements.define("download-button", DownloadButton);
</script>
